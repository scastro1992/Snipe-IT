# Script para integraÃ§Ã£o com Snipe-IT
# Objetivo: Registrar ou atualizar um asset no Snipe-IT a partir das informaÃ§Ãµes coletadas localmente.

# ============================
# ğŸ” ConfiguraÃ§Ãµes Iniciais
# ============================
$apikey = ""
$url = ""

# InstalaÃ§Ã£o e ImportaÃ§Ã£o dos MÃ³dulos necessÃ¡rios
Install-PackageProvider -Name NuGet -Force
if (-not (Get-Module SnipeitPS -ListAvailable)) {
    Install-Module SnipeitPS -Force
}
Update-Module SnipeitPS
Import-Module SnipeitPS

# ============================
# ğŸ”„ VerificaÃ§Ã£o da ConexÃ£o
# ============================
try {
    Connect-SnipeitPS -URL $url -apiKey $apikey
    Write-Host "âœ… ConexÃ£o com Snipe-IT estabelecida com sucesso."
} catch {
    Write-Host "âŒ Falha na conexÃ£o com Snipe-IT. Verifique a URL e a API Key."
    exit
}

# ============================
# ğŸ’» Coleta de InformaÃ§Ãµes do Computador
# ============================
$computerName = $env:COMPUTERNAME
$serialNumber = (Get-WmiObject win32_bios).SerialNumber
$modelno = (Get-WmiObject -class Win32_ComputerSystem).Model
$manufacturer = (Get-WmiObject -class Win32_ComputerSystem).Manufacturer
$SystemType = (Get-WmiObject -class Win32_ComputerSystem).PCSystemType

# ============================
# ğŸ”„ VerificaÃ§Ã£o do Fabricante
# ============================
$Assetmanufacturer = Get-SnipeitManufacturer | Where-Object {$_.name -like "*$manufacturer*"}

if (-not $Assetmanufacturer) {
    Write-Host "ğŸ” Fabricante nÃ£o encontrado. Criando novo fabricante: $manufacturer"
    try {
        $Assetmanufacturer = New-SnipeitManufacturer -Name $manufacturer
        Write-Host "âœ… Fabricante $manufacturer criado com sucesso."
    } catch {
        Write-Host "âŒ Erro ao criar fabricante. Verifique as permissÃµes."
        exit
    }
}

# ============================
# ğŸ”„ VerificaÃ§Ã£o do Modelo
# ============================
$Categoryid = if ($SystemType -eq 2) { 4 } elseif ($SystemType -eq 1) { 3 } else { 1 }

$modelSelection = Get-SnipeitModel | Where-Object {$_.name -like "*$modelno*"}

if (-not $modelSelection) {
    Write-Host "ğŸ” Modelo nÃ£o encontrado. Criando novo modelo: $modelno"
    try {
        $modelSelection = New-SnipeitModel -Name $modelno -category_id $Categoryid -manufacturer_id $Assetmanufacturer.id -fieldset_id 5
        Write-Host "âœ… Modelo $modelno criado com sucesso."
    } catch {
        Write-Host "âŒ Erro ao criar modelo. Verifique as permissÃµes."
        exit
    }
}

# ============================
# ğŸ”„ VerificaÃ§Ã£o do Asset
# ============================
$assetExists = Get-SnipeitAsset -search $serialNumber

if ($assetExists) {
    Write-Host "ğŸ”„ Asset Existente: $($assetExists.id) - Atualizando informaÃ§Ãµes..."
    Set-SnipeitAsset -id $($assetExists.id) -Name $computerName -Model_id $modelSelection.id -Serial $serialNumber -Status "2"
    Write-Host "âœ… Asset atualizado com sucesso."
} else {
    Write-Host "â• Asset nÃ£o encontrado - Criando novo asset no Snipe-IT..."
    New-SnipeitAsset -Name $computerName -tag $serialNumber -Serial $serialNumber -Model_id $modelSelection.id -Status "2"
    Write-Host "âœ… Asset criado com sucesso."
}

Write-Host "ğŸ Processo finalizado com sucesso."